#!/bin/bash

function android_app_backup() {
  local package="$1"
  adb backup -f ~/Documents/adb_backup/GMBackup.ab -n oapk $package
}

function android_type_text() {
  local text=$1

  adb shell input text "${text// /%s}"
}

function android_clear_input() {
  local loop_count=$1

  adb shell input keyevent KEYCODE_MOVE_END

  for i in $(seq $loop_count)
  do
    adb shell input keyevent KEYCODE_DEL
  done
}

function android_current_activity() {
  current_activity=$(adb shell dumpsys activity activities | grep --color=auto --exclude-dir={.bzr,CVS,.git,.hg,.svn} mResumedActivity | cut -d . -f 5 | cut -d ' ' -f 1)

  if [[ $current_activity != *"Activity" ]]; then
    current_activity=$(adb shell dumpsys activity activities | grep mFocusedActivity | cut -d . -f 5 | cut -d ' ' -f 1)
  fi

  echo $current_activity
}

function android_current_list_activity() {
  current_activity=$(adb shell dumpsys activity activities | grep --color=auto --exclude-dir={.bzr,CVS,.git,.hg,.svn} mResumedActivity | cut -d . -f 6 | cut -d ' ' -f 1)

  if [[ $current_activity != *"Activity" ]]
  then
    current_activity=$(adb shell dumpsys activity activities | grep mFocusedActivity | cut -d . -f 5 | cut -d ' ' -f 1)
  fi

  echo $current_activity
}

function android_screenshot() {

    name="$1"

    if [[ -n $name ]]; then
      adb shell screencap -p | perl -pe 's/\x0D\x0A/\x0A/g' > $name.png
      open $name.png
    else
      adb shell screencap -p | perl -pe 's/\x0D\x0A/\x0A/g' > screen.png
      open screen.png
    fi
}

function android_clear_app_data() {

  package="$1"

  if [[ -n "$package" ]]; then
    adb shell input keyevent 3
    adb shell pm clear $package
  else
    error "Should pass a app package name"
  fi
}
